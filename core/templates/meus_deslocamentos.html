{% extends 'header.html' %}

{% block content %}
    <h2>Seus deslocamentos registrados</h2>
    <div id="form-container">
        {% for form in formset %}
            <form method="post" id="{{ form.prefix }}">
                {% csrf_token %}
                {{ formset.management_form }}
                <div>
                    {{ form.as_p }}
                    {% if form.instance.pk %}
                        <button type="submit">Editar</button>
                    {% else %}
                        <button type="button" onclick="salvarDeslocamento('{{ form.prefix }}')">Salvar</button>
                    {% endif %}
                </div>
            </form>
        {% endfor %}
    </div>

    <button type="button" id="adicionar-deslocamento">Adicionar Deslocamento</button>

    <div id="novo-deslocamento" style="display: none;">

        <div id="modelo-deslocamento" style="display: none;">
            <div class="deslocamento">
                <label for="id_deslocamentos-0-dia_semana">Dia da Semana:</label>
                <input type="text" id="id_deslocamentos-0-dia_semana" name="deslocamentos-0-dia_semana">
                <label for="id_deslocamentos-0-hora_ida">Hora de Ida:</label>
                <input type="time" id="id_deslocamentos-0-hora_ida" name="deslocamentos-0-hora_ida">
                <label for="id_deslocamentos-0-hora_volta">Hora de Volta:</label>
                <input type="time" id="id_deslocamentos-0-hora_volta" name="deslocamentos-0-hora_volta">

                <input type="hidden" id="id_deslocamentos-0-ponto_saida" name="deslocamentos-0-ponto_saida">
                <input type="hidden" id="id_deslocamentos-0-ponto_destino" name="deslocamentos-0-ponto_destino">
            </div>
        </div>

        <div id="deslocamentos-container">
        </div>

        <button type="button" id="adicionar-deslocamento-final">Adicionar Novo Deslocamento</button>
    </div>

    <div id="map" style="height: 200px;"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        $(document).ready(function() {
            let deslocamentoCount = 0;
            const modeloDeslocamento = $('#modelo-deslocamento').html();

            $('#adicionar-deslocamento').click(function() {
                $('#novo-deslocamento').toggle();
                if ($('#novo-deslocamento').is(':visible')) {
                    adicionarDeslocamento();
                }
            });

            $('#adicionar-deslocamento-final').click(function() {
                adicionarDeslocamento();
            });

            function adicionarDeslocamento() {
                deslocamentoCount++;
                const novoDeslocamento = modeloDeslocamento.replace(/id_deslocamentos-0-/g, `id_deslocamentos-${deslocamentoCount}-`);
                $('#deslocamentos-container').append(novoDeslocamento);
            }

            var map = L.map('map').setView([-23.5505, -46.6333], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e){
              var coord = e.latlng;
              var lat = coord.lat;
              var lng = coord.lng;
              console.log("You clicked the map at latitude: " + lat + " and longitude: " + lng);
              });

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    map.setView([userLat, userLng], 12);
                });
            }
        });
    </script>
{% endblock %}
